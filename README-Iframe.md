# Authenticating using the Toopher `iframe`

Toopher's `iframe`-based authentication flow is the simplest way for web developers to integrate Toopher Two-Factor Authentication into an application.

## Toopher `iframe` Authentication Overview

The `iframe`-based authentication flow works by inserting an `<iframe>` element into the HTML displayed to the user after a successful username/password validation (but before they are actually logged-in to the service).  The `iframe` URL is generated by our library and its content is served from the Toopher API server.  The `iframe` guides the user through the process of authenticating with Toopher.  Once complete, the `iframe` will return the result of the authentication to your server by `POST`ing the response via HTML to an endpoint of your choice.  Your server validates the cryptographic signature using our library which determines whether or not the user successfully authenticated.

Two distinct `iframe` flows are available: 

* **Simple** serve an all-in-one `iframe` that handles *Pairing* and
  *Authentication*
* **More flexible** serve the *Pairing* `iframe` and the *Authentication* `iframe` as needed. Note: a *Pairing* request is used to pair a user account with a particular mobile device (this is typically a one-time process); an *Authentication* request is used to authenticate a particular action on behalf of a user

## Authentication Workflow

### Step 0: Primary Authentication

We recommend using some form of primary authentication before initiating a Toopher authentication request.  Typical primary authentication methods involve verifying that the user has a valid username and password to access the resource being protected.

### Step 1: Embed a request in an `<iframe>`

After verifying the user's primary authentication, but before Assuming the user's primary authentication checks out, the next step is to kickoff Toopher authentication.

1. Generate a URI by specifying the request parameters to the library as detailed below
1. Display a webpage to your user that embeds this URI within an `<iframe>` element.  The markup requirements for the `<iframe>` element are described in the "HTML Markup" section

### Step 2: Validate the result
1. Toopher-iframe results posted back to server
1. Server calls `ToopherIframe.validate()` to verify that result is valid.  `.validate()` returns a `Map` of trusted data if the signature is valid, or throws a `SignatureValidationError` if the signature is invalid.
1. The server should check for possible errors returned by the API in the `error_code` map entry
1. If no errors were returned, the result of the authentication is in the `granted` map entry

### HTML markup
The `<iframe>` element must have an id of `toopher_iframe`.

Pages that include the Toopher Authentication or Pairing `iframe` must include the accompanying javascript library `toopher-web.js` (located in `/assets/js/` in this repository).  Toopher's Authentication and Pairing `<iframe>` content is designed for a minimum size of 400x300 px.  In the example below, `{{IFRAME_REQUEST_URL}}` is the Authentication or Pairing URL generated by the ToopherIframe library.  `{{POSTBACK_URL}}` is the path on your server where the Toopher-Iframe will submit the result of the authentication when it is finished.

    <!-- toopher-web.js requires jQuery.  uncomment the following line to source it from CDNJS if it is not already included in your page -->
    <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> -->
    <script src="/js/toopher-web.js"></script>
    <iframe id="toopher_iframe" src="{{IFRAME_REQUEST_URL}}" toopher_postback="{{POSTBACK_URL}}" style="display:inline-block; height:300px; width:100%;"></iframe>

There is no difference in the markup required for a Pairing vs. an Authentication `iframe` request (the generated URI embeds all relevant information).

## Examples

### All-in-one iframe

#### Generating an iframe URI

Every Toopher Authentication session should include a unique `requestToken` - a randomized `String` that is included in the signed request to the Toopher API and returned in the signed response from the Toopher `iframe`.  To guard against potential replay attacks, your code should validate that the returned `requestToken` is the same one used to create the request.

Creating a random request token and storing it in the server-side session using the Java Servlet API:

    private static final SecureRandom secureRandom = new SecureRandom();
    // simple way to generate a randomized string.  
    String requestToken = new BigInteger(20 * 8, secureRandom).toString(32);
    request.getSession().setAttribute("ToopherRequestToken", requestToken);

The Toopher Authentication API provides the requester a rich set of controls over authentication parameters.

    String authIframeUrl = iframeApi.authUri(userName, resetEmail, actionName, automationAllowed, challengeRequired, requestToken, requesterMetadata, ttl);

For the simple case of authenticating a user at login, a `loginIframeUrl` helper method is available:

    String loginIframeUrl = iframeApi.loginUri(userName, resetEmail, requestToken)

When the the `iframe` is served this way Toopher will determine if the
input `userName` is already paired; if they have not, we will show the
*Pairing* steps. After the user has paired the *Authentication* steps will be shown.

#### Validating postback data from the iframe and parsing API errors

In this example, `data` is a `Map<String, String[]>` of the form data POSTed to your server from the Toopher Authentication `iframe`.  You should replace the commented blocks with code appropriate for the condition described in the comment.

    Map<String, String[]> data = httpServletRequest.getParameterMap();
    String requestToken = (String)request.getSession().getAttribute("ToopherRequestToken");
    // invalidate the Request Token to guard against replay attacks
    request.getSession().removeAttribute("ToopherRequestToken");

    try {
        Map<String, String> validatedData = iframeApi.validate(data, requestToken);
        if (validatedData.containsKey("error_code")) {
            String errorCode = validatedData.get("error_code");
            // There was an error -- user should not be authenticated
        } else {
            // Signature is valid with no api errors -- check authentication result
            boolean authPending = validatedData.get("pending").toLowerCase().equals("true");
            boolean authGranted = validatedData.get("granted").toLowerCase().equals("true");

            // authenticationResult is the ultimate result of Toopher second-factor authentication
            boolean authenticationResult = authGranted && !authPending;
            if (authenticationResults) {
                // Log user in
            } else {
                // Fail authentication attempt
            }
        }
    } catch (ToopherIframe.SignatureValidationError e) {
        // Signature was invalid -- user should not be authenticated
        // 
        // e.getMessage() will return more information about what specifically
        // went wrong (incorrect session token, expired TTL, invalid signature)
    }

### Separate Pairing and Authentication iframes

#### Generating an Authentication iframe URI

Every Toopher Authentication session should include a unique `requestToken` - a randomized `String` that is included in the signed request to the Toopher API and returned in the signed response from the Toopher `iframe`.  To guard against potential replay attacks, your code should validate that the returned `requestToken` is the same one used to create the request.

Creating a random request token and storing it in the server-side session using the Java Servlet API:

    private static final SecureRandom secureRandom = new SecureRandom();
    // simple way to generate a randomized string.  
    String requestToken = new BigInteger(20 * 8, secureRandom).toString(32);
    request.getSession().setAttribute("ToopherRequestToken", requestToken);

The Toopher Authentication API provides the requester a rich set of controls over authentication parameters.

    String authIframeUrl = iframeApi.authUri(userName, resetEmail, actionName, automationAllowed, challengeRequired, requestToken, requesterMetadata, ttl);

For the simple case of authenticating a user at login, a `loginIframeUrl` helper method is available:

    String loginIframeUrl = iframeApi.loginUri(userName, resetEmail, requestToken)

#### Generating a Pairing iframe URI

    String pairIframeUrl = iframeApi.pairUri(userName, resetEmail)

#### Validating postback data from Authentication iframe and parsing API errors

In this example, `data` is a `Map<String, String[]>` of the form data POSTed to your server from the Toopher Authentication `iframe`.  You should replace the commented blocks with code appropriate for the condition described in the comment.

    Map<String, String[]> data = httpServletRequest.getParameterMap();
    String requestToken = (String)request.getSession().getAttribute("ToopherRequestToken");
    // invalidate the Request Token to guard against replay attacks
    request.getSession().removeAttribute("ToopherRequestToken");

    try {
        Map<String, String> validatedData = iframeApi.validate(data, requestToken);
        if (validatedData.containsKey("error_code")) {
            // check for API errors
            String errorCode = validatedData.get("error_code");
            if (errorCode.equals(ToopherIframe.PAIRING_DEACTIVATED)) {
                // User deleted the pairing on their mobile device.
                // 
                // Your server should display a Toopher Pairing iframe so their account can be re-paired
                //
            } else if (errorCode.equals(ToopherIframe.USER_OPT_OUT)) {
                // User has been marked as "Opt-Out" in the Toopher API
                //
                // If your service allows opt-out, the user should be granted access.
                //
            } else if (errorCode.equals(ToopherIframe.USER_UNKNOWN)) {
                // User has never authenticated with Toopher on this server
                //
                // Your server should display a Toopher Pairing iframe so their account can be paired
                //
            }
        } else {
            // Signature is valid, and no api errors -- check authentication result
            boolean authPending = validatedData.get("pending").toLowerCase().equals("true");
            boolean authGranted = validatedData.get("granted").toLowerCase().equals("true");

            // authenticationResult is the ultimate result of Toopher second-factor authentication
            boolean authenticationResult = authGranted && !authPending;
            if (authenticationResults) {
                // Log user in
            } else {
                // Fail authentication attempt
            }
        }
    } catch (ToopherIframe.SignatureValidationError e) {
        // Signature was invalid -- user should not authenticated
        // 
        // e.getMessage() will return more information about what specifically
        // went wrong (incorrect session token, expired TTL, invalid signature)
        // 
    }
